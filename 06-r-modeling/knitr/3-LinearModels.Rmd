---
title: "Statistical Modeling"
subtitle: "In R"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	cache = TRUE
)
```

class: center, middle

# Linear Models (and more!)

---

# Outline

+ One Way ANOVA

+ Two-way ANOVA 

  + Qualitative/Qualitative
  
  + Quantitative/Qualitative
  
+ Blocking

---

# Overarching Example

A plant pathology researcher is studying the effect of an experimental fungicide on the fresh weight of azaleas inoculated with a certain fungus. She has 49 potted plants of a particular azalea variety growing in a greenhouse. All plants are inoculated with a fungus. To start, she has 7 different fungicide combinations, with 7 plants per treatment.(Example from Lentner and Bishop, *Experimental Design and Analysis (2nd)*)

```{r echo = TRUE}
azalea <- read.csv("https://srvanderplas.github.io/rwrks/06-r-modeling/data/AzaleaOneWay.csv")
head(azalea)
```

**Note**: As we go along, we will continue to use this scenario; we will just continue to get more specific on what the treatments are. The dataset will be updated accordingly as well.

---

# One-Way Analysis of Variance (ANOVA)

+ Essentially an expansion of the t-test [Source](https://tjfisher19.github.io/introStatModeling/introduction-to-statistical-modeling-and-designed-experiments.html#one-way-anova)

+ Compare more than 2 levels of a treatment factor

  - Treatment factor is your independent variable, the variable you expect to possibly cause the variation we see in the response. (i.e. the fungicide combination)
  
  - Levels are the subdivisions of your overall treatment factor. (i.e. the 7 different combinations)
  
  - If you only have two levels of a factor, a One-Way ANOVA would be equivalent to t-test.
  
+ Randomly sample your experimental units, and then randomly assign them to the different levels of the treatment factor.

---

# One-Way ANOVA Model

$$y_{ij} = \mu + \tau_i + \varepsilon_{ij}$$

+ $y_{ij}$ is the response of the $j^{th}$ observation in the $i^{th}$ treatment level
+ $\mu$ is the overall/grand mean
+ $\tau_i$ is the effect of the $i^{th}$ treatment level
+ $\varepsilon_{ij} \sim N(0,\sigma^2)$ is the residual error

In terms of our example:

+ $y_{ij}$ is the fresh weight of the $j^{th}$ azalea in the $i^{th}$ fungicide level
+ $\mu$ is the overall/grand mean
+ $\tau_i$ is the effect of the $i^{th}$ fungicide level
+ $\varepsilon_{ij} \sim N(0,\sigma^2)$ is the residual error

---

# One-Way ANOVA Hypotheses

$$H_0: \mu_1 = \mu_2 = ... = \mu_n$$
$$H_A: \text{at least one } \mu_i \text{ is different}$$

OR

$$H_0: \tau_1 = \tau_2 = ... = \tau_n = 0$$
$$H_A: \text{at least one } \tau_i \ne 0$$

These hypotheses are **equivalent**, just being expressed in two different ways.

---

# One-Way ANOVA in R

+ When running this in R, **make sure** the variables are the type you need them.
+ The following code is incorrect... why?

```{r echo=TRUE}
library(car)
#mod.fit <- lm(response ~ trt, data = data)
mod.fit <- lm(Weight ~ Trt, data = azalea)
Anova(mod.fit, type = "II")
```

+ Note the only 1 degree of freedom with treatment. We should have 6!

---

# One-Way ANOVA in R

+ When running this in R, **make sure** the variables are the type you need them.
+ Change `Trt` to a factor!

```{r echo=TRUE}
library(car)
#mod.fit <- lm(response ~ trt, data = data)
azalea$Trt.new <- as.factor(azalea$Trt)
mod.fit <- lm(Weight ~ Trt.new, data = azalea)
Anova(mod.fit, type = "II")
```

+ We do not have evidence of an effect of fungicide combination on the mean fresh weight of azaleas.

---

# But what if we did have a difference?!

+ If you reject the null hypothesis in a One-Way ANOVA, the result only tells you that **at least** one mean is different (i.e. at least one treatment level is different from the others).
+ We want to know *which* treatment levels are different!
+ Use `emmeans`

---

# `emmeans` results

```{r echo=TRUE}
library(emmeans)
emmeans(mod.fit, pairwise ~ Trt.new)
```

---

# New Information!

Suppose you find out from the researchers that are actually only two fungicides used. Treatment 1 is a standard fungicide, Truban (**T**), and is used as a control in the experiment. Treatments 2-7 are the experimental fungicide, Nurell (**N**), that is applied at different times and rates. The researchers want to compare **T** and **N** to see if there is a difference between these two fungicide treatments.

---

# How do we address this new information?

+ Contrast!
+ We can write a specific test that uses our model from before to test for a difference between **T** and **N**. 

| 1       | 2       | 3       | 4       | 5       | 6       | 7       |
|---------|---------|---------|---------|---------|---------|---------|
| T       | N       | N       | N       | N       | N       | N       |
| $\mu_1$ | $\mu_2$ | $\mu_3$ | $\mu_4$ | $\mu_5$ | $\mu_6$ | $\mu_7$ |

+ We would average together treatments 2-7 and compare to treatment 1.

$$H_0: \mu_1 = \frac{\mu_2 + \mu_3 + \mu_4 + \mu_5 + \mu_6 + \mu_7}{6}$$

$$H_A: \mu_1 \ne \frac{\mu_2 + \mu_3 + \mu_4 + \mu_5 + \mu_6 + \mu_7}{6}$$

---

# Contrast in R

```{r}
options(width = 50)
```

+ If you care about the estimate and standard error:
```{r echo=TRUE}
library(gmodels)
fit.contrast(mod.fit, "Trt.new", c(1, -1/6, -1/6, -1/6, -1/6, -1/6, -1/6))
```

---

# Contrast in R

+ If you **only care** about the test:
```{r echo=TRUE}
fit.contrast(mod.fit, "Trt.new", c(6, -1, -1, -1, -1, -1, -1))
```

+ Again, no evidence there is a difference between the mean fresh weight of **T** and **N**.

---

# More information!

Now that the researchers know there isn't a difference between the **T** and **N** fungicides, they want to know more about the **N** fungicide specifically. You learn that this fungicide was applied either 3 days before inoculation or 7 days after inoculation. Additionally, it is applied at either the 1 oz., 3 oz., or 5 oz. dose rates.

| N             | N             | N             | N            | N            | N            |
|---------------|---------------|---------------|--------------|--------------|--------------|
| 3 days before | 3 days before | 3 days before | 7 days after | 7 days after | 7 days after |
| 1 oz.         | 3 oz.         | 5 oz.         | 1 oz.        | 3 oz.        | 5 oz.        |

Now, instead of a single treatment factor, we have 2! We have time of application and rate of application. Thus, a One-Way ANOVA will no longer suffice. 

---

# Two-Way ANOVA

+ Extension of One-Way ANOVA, we just now have two treatment factors instead of one.

+ When dealing with more than one treatment factor, our treatment design is now a *factorial*.

+ You have an $i \times j$ factorial
  - $i$ is the number of levels of treatment 1
  - $j$ is the number of levels of treatment 2
  - So in our example, we have a $2 \times 3$ factorial.
  
+ We are interested in knowing if the two treatment factors *interact* in their effect on the response.
  - If the response of one factor strongly depends on the level of the other factor, the two factors are said to *interact*.

---

# Two-Way ANOVA Model

$$y_{ijk} = \mu + \alpha_i + \beta_j + \alpha\beta_{ij} + \varepsilon_{ijk}$$

+ $y_{ijk}$ is the response of the $k^{th}$ observation in the $i^{th}$ treatment level of treatment 1 and the $j^{th}$ treatment level of treatment 2
+ $\mu$ is the overall/grand mean
+ $\alpha_i$ is the effect of the $i^{th}$ treatment level of treatment 1
+ $\beta_j$ is the effect of the $j^{th}$ treatment level of treatment 2
+ $\alpha\beta_{ij}$ is the interaction effect of the $i^{th}$ and $j^th$ treatment levels of treatments 1 and 2 respectively
+ $\varepsilon_{ijk} \sim N(0,\sigma^2)$ is the residual error

---

# Two-Way ANOVA Model cont.

In terms of our example:

+ $y_{ijk}$ is the fresh weight of the $k^{th}$ azalea in the $i^{th}$ treatment level of time of application and the $j^{th}$ treatment level of application rate
+ $\mu$ is the overall/grand mean
+ $\alpha_i$ is the effect of the $i^{th}$ treatment level of time of application
+ $\beta_j$ is the effect of the $j^{th}$ treatment level of application rate
+ $\alpha\beta_{ij}$ is the interaction effect of the $i^{th}$ and $j^th$ treatment levels of time of application and application rate respectively
+ $\varepsilon_{ijk} \sim N(0,\sigma^2)$ is the residual error

---

# Two-Way ANOVA Hypotheses

+ The first set of hypotheses we analyze with a Two-Way ANOVA is a test of the interaction.

$$H_0: \text{There is no interaction.}$$
$$H_A: \text{There is an interaction.}$$

+ If we **reject** the null hypothesis and conclude there is an interaction, we proceed by looking at the *simple effects*. 

  - The difference between means of two levels of one factor **at a single level of the other factor**.
  
+ If we **fail to reject** the null hypothesis and conclude there is no evidence of an interaction, we proceed by looking at the *main effects*.

  - The means for each level of one factor averaged over the levels of the other.
  
---

# Two-Way ANOVA in R