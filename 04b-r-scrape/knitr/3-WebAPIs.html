<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Web APIs in R</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Web APIs in R
## Using jsonlite

---

&lt;style&gt;
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
&lt;/style&gt;

## Web APIs

- [Server-side Web APIs](https://en.wikipedia.org/wiki/Web_API#Server-side) (Application Programming Interfaces) are a popular way to provide easy access to data and other services. 
- If you (the client) want data from a server, you typically need one HTTP verb -- `GET`.


```r
library(httr)
sam &lt;- GET("https://api.github.com/users/sctyner")
content(sam)[c("name", "company")]
```

```
## $name
## [1] "Sam Tyner"
## 
## $company
## [1] "@Tritura"
```

- Other HTTP verbs -- `POST`, `PUT`, `DELETE`, etc...

---

## Request/response model 

- When you (the client) _requests_ a resource from the server. The server _responds_ with a bunch of additional information.


```r
sam$header[1:3]
```

```
## $server
## [1] "GitHub.com"
## 
## $date
## [1] "Thu, 13 Jan 2022 01:48:50 GMT"
## 
## $`content-type`
## [1] "application/json; charset=utf-8"
```

- Nowadays content-type is usually XML or JSON (HTML is great for _sharing content_ between _people_, but it isn't great for _exchanging data_ between _machines_.)

---

## What is XML?

XML is a markup language that looks very similar to HTML.

```xml
&lt;mariokart&gt;
  &lt;driver name="Bowser" occupation="Koopa"&gt;
    &lt;vehicle speed="55" weight="25"&gt; Wario Bike &lt;/vehicle&gt;
    &lt;vehicle speed="40" weight="67"&gt; Piranha Prowler &lt;/vehicle&gt;
  &lt;/driver&gt;
  &lt;driver name="Peach" occupation="Princess"&gt;
    &lt;vehicle speed="54" weight="29"&gt; Royal Racer &lt;/vehicle&gt;
    &lt;vehicle speed="50" weight="34"&gt; Wild Wing &lt;/vehicle&gt;
  &lt;/driver&gt;
&lt;/mariokart&gt;
```

- This example shows that XML can (and is) used to store inherently tabular data ([thanks Jeroen Ooms](http://arxiv.org/pdf/1403.2805v1.pdf))
- What is are the observational units here? How many observations in total?
- 2 units and 6 total observations (4 vehicles and 2 drivers).

---

## XML2R
[XML2R](https://github.com/cpsievert/XML2R) is a framework to simplify acquisition of tabular/relational XML.

* **XML2R** coerces XML into a *flat* list of observations.
* The list names track the "observational unit".
* The list values track the "observational attributes".


```
##   mariokart..driver..vehicle.speed mariokart..driver..vehicle.weight
## 1                               55                                25
##   mariokart..driver..vehicle.XML_value
## 1                          Wario Bike 
##                                                                                                 mariokart..driver..vehicle.url
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
##   mariokart..driver..vehicle.speed.1 mariokart..driver..vehicle.weight.1
## 1                                 40                                  67
##   mariokart..driver..vehicle.XML_value.1
## 1                       Piranha Prowler 
##                                                                                               mariokart..driver..vehicle.url.1
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
##   mariokart..driver.name mariokart..driver.occupation
## 1                 Bowser                        Koopa
##                                                                                                          mariokart..driver.url
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
##   mariokart..driver..vehicle.speed.2 mariokart..driver..vehicle.weight.2
## 1                                 54                                  29
##   mariokart..driver..vehicle.XML_value.2
## 1                           Royal Racer 
##                                                                                               mariokart..driver..vehicle.url.2
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
##   mariokart..driver..vehicle.speed.3 mariokart..driver..vehicle.weight.3
## 1                                 50                                  34
##   mariokart..driver..vehicle.XML_value.3
## 1                             Wild Wing 
##                                                                                               mariokart..driver..vehicle.url.3
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
##   mariokart..driver.name.1 mariokart..driver.occupation.1
## 1                    Peach                       Princess
##                                                                                                        mariokart..driver.url.1
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
```

```
## 
##          mariokart//driver mariokart//driver//vehicle 
##                          2                          4
```


---


```r
head(obs) # named list of observations
```

```
## $`mariokart//driver//vehicle`
##      speed weight XML_value     
## [1,] "55"  "25"   " Wario Bike "
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver//vehicle`
##      speed weight XML_value          
## [1,] "40"  "67"   " Piranha Prowler "
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver`
##      name     occupation
## [1,] "Bowser" "Koopa"   
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver//vehicle`
##      speed weight XML_value      
## [1,] "54"  "29"   " Royal Racer "
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver//vehicle`
##      speed weight XML_value    
## [1,] "50"  "34"   " Wild Wing "
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver`
##      name    occupation
## [1,] "Peach" "Princess"
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
```

---

## Collapse the observations
- What information have I lost?
- I can't map vehicles to the drivers!


```r
collapse_obs(obs) # group into table(s) by observational name/unit
```

```
## $`mariokart//driver`
##      name     occupation
## [1,] "Bowser" "Koopa"   
## [2,] "Peach"  "Princess"
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [2,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver//vehicle`
##      speed weight XML_value          
## [1,] "55"  "25"   " Wario Bike "     
## [2,] "40"  "67"   " Piranha Prowler "
## [3,] "54"  "29"   " Royal Racer "    
## [4,] "50"  "34"   " Wild Wing "      
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [2,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [3,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [4,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
```

---

## Code to use Collapse observations

```r
library(dplyr)
obs &lt;- add_key(obs, parent = "mariokart//driver", recycle = "name")
```

```
## A key for the following children will be generated for the mariokart//driver node:
## mariokart//driver//vehicle
```

```r
collapse_obs(obs)
```

```
## $`mariokart//driver`
##      name     occupation
## [1,] "Bowser" "Koopa"   
## [2,] "Peach"  "Princess"
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [2,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## 
## $`mariokart//driver//vehicle`
##      speed weight XML_value          
## [1,] "55"  "25"   " Wario Bike "     
## [2,] "40"  "67"   " Piranha Prowler "
## [3,] "54"  "29"   " Royal Racer "    
## [4,] "50"  "34"   " Wild Wing "      
##      url                                                                                                                           
## [1,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [2,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [3,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
## [4,] "https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml"
##      name    
## [1,] "Bowser"
## [2,] "Bowser"
## [3,] "Peach" 
## [4,] "Peach"
```

---

## Now (if I want) I can merge the tables into a single table...


```r
tabs &lt;- collapse_obs(obs)
left_join(as.data.frame(tabs[[1]]), as.data.frame(tabs[[2]])) 
```

```
## Joining, by = c("name", "url")
```

```
##     name occupation
## 1 Bowser      Koopa
## 2 Bowser      Koopa
## 3  Peach   Princess
## 4  Peach   Princess
##                                                                                                                            url
## 1 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
## 2 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
## 3 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
## 4 https://gist.githubusercontent.com/cpsievert/85e340814cb855a60dc4/raw/651b7626e34751c7485cff2d7ea3ea66413609b8/mariokart.xml
##   speed weight         XML_value
## 1    55     25       Wario Bike 
## 2    40     67  Piranha Prowler 
## 3    54     29      Royal Racer 
## 4    50     34        Wild Wing
```

---

## What about JSON? 

- JSON is _the_ format for data on the web.
- JavaScript Object Notation (JSON) is comprised of two components:
    * arrays =&gt; [value1, value2]
    * objects =&gt; {"key1": value1, "key2": [value2, value3]} 
- [jsonlite](http://cran.r-project.org/web/packages/jsonlite/index.html) is the preferred R package for parsing JSON (it's even used by Shiny!)
- Understanding Third-party JSONs with extensive documentation or creating your own JSONs, using [Postman](https://www.postman.com/product/what-is-postman/) could be helpful. The tool is free to use and explore with fees for creating APIs.

![](images/Postman.png)



---
## Back to Mariokart 

What does raw JSON code look like anyway??

```json
[
    {
        "driver": "Bowser",
        "occupation": "Koopa",
        "vehicles": [
            {
                "model": "Wario Bike",
                "speed": 55,
                "weight": 25
            },
            {
                "model": "Piranha Prowler",
                "speed": 40,
                "weight": 67
            }
        ]
    },
    {
        "driver": "Peach",
        "occupation": "Princess",
        "vehicles": [
            {
                "model": "Royal Racer",
                "speed": 54,
                "weight": 29
            },
            {
                "model": "Wild Wing",
                "speed": 50,
                "weight": 34
            }
        ]
    }
]
```

---

## JSON Code Example


```r
library(jsonlite)
```

```
## 
## Attaching package: 'jsonlite'
```

```
## The following object is masked from 'package:purrr':
## 
##     flatten
```

```r
mario &lt;- fromJSON("http://bit.ly/mario-json")
str(mario) 
```

```
## 'data.frame':	2 obs. of  3 variables:
##  $ driver    : chr  "Bowser" "Peach"
##  $ occupation: chr  "Koopa" "Princess"
##  $ vehicles  :List of 2
##   ..$ :'data.frame':	2 obs. of  3 variables:
##   .. ..$ model : chr  "Wario Bike" "Piranha Prowler"
##   .. ..$ speed : int  55 40
##   .. ..$ weight: int  25 67
##   ..$ :'data.frame':	2 obs. of  3 variables:
##   .. ..$ model : chr  "Royal Racer" "Wild Wing"
##   .. ..$ speed : int  54 50
##   .. ..$ weight: int  29 34
```

---

## List Items from Mario Kart Web Scrape
- How do we get two tables (with a common id) like the XML example?


```r
mario$driver
```

```
## [1] "Bowser" "Peach"
```

```r
mario$vehicles
```

```
## [[1]]
##             model speed weight
## 1      Wario Bike    55     25
## 2 Piranha Prowler    40     67
## 
## [[2]]
##         model speed weight
## 1 Royal Racer    54     29
## 2   Wild Wing    50     34
```


```r
vehicles &lt;- rbind(mario$vehicles[[1]], mario$vehicles[[2]])
vehicles &lt;- cbind(driver = mario$driver, vehicles)
```

---

## Helpful Web API sites (Survey Responses)
- [USDA API](https://quickstats.nass.usda.gov/api)
- [FDA API](https://open.fda.gov/apis/try-the-api/)
- [Qualtrics Data Retrieve in Real Time API](https://api.qualtrics.com/api-reference/ZG9jOjg3NzY3MQ-retrieve-survey-responses-in-real-time)
- [FAO Stats API*](https://www.programmableweb.com/api/faostat-data-rest-api)

*FAO Stats actually has a R package that you can use [here](https://cran.r-project.org/web/packages/FAOSTAT/FAOSTAT.pdf)

---

## Your Turn 

1. Get the json data for our R workshop GitHub commit history:


```r
workshop_commits_raw &lt;- fromJSON("https://api.github.com/repos/heike/rwrks/commits")
```

2. Find the table of commits contained in this list. Hint: It's all about the `$`

3. Plot the total number of commits (number of rows) by user as a bar chart

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
